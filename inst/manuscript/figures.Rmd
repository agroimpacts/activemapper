---
title: Figures
output:
  prettydoc::html_pretty:
    theme: tactile
    highlight: github
    math: katex
    toc_depth: 4
    toc: yes
    css: css/vignette.css
---

```{r setup, include=FALSE, cache=FALSE, message = FALSE}
library(raster)
library(sf)
library(dplyr)
library(tidyr)
library(ggplot2)
library(here)
library(RColorBrewer)
library(activemapper)
pth <- function(x) file.path(here("inst/manuscript"), x)
```

Creation of figures for main manuscript and the supplementary information. 

## Base Datasets

The preparation of datasets used here and which install with the `activemapper` package, is shown in `data-raw/data_[from|to]_instances.R`. These are loaded in here. 

```{r, eval=FALSE}
res <- 0.005
res_supergrid <- 1
num_supergrid <- res_supergrid / res

mgridr <- raster(
  system.file("extdata/ghana_grid.tif", package = "activemapper")
)
mgrid <- readr::read_csv(
  system.file("extdata", "ghana_grid.csv", package = "activemapper")
) %>% select(-fwts)
africa <- st_read(
  system.file("extdata/africa.geojson", package = "activemapper")
)
africa_cont <- africa %>% st_union %>% st_sf
ghana <- africa %>% filter(name == "Ghana") %>% select(geometry)

degrees <- st_read(
  system.file("extdata/degrees.geojson", package = "activemapper")
)
tiles <- st_read(
  system.file("extdata/ghana_tiles.geojson", package = "activemapper")
) 
aois <- st_read(
  system.file("extdata/aois.geojson", package = "activemapper")
)
# ggplot(data = tiles) + 
#   geom_sf(aes(fill = as.factor(aoi1)), col = "transparent")

# database results
load(system.file("extdata/", "instance_tbls.rda", package = "activemapper"))
```


## Methods 

### Figure 1: System architecture
Created in keynote

### Figure 2: Grid system and AOIs

```{r, eval = FALSE}
ghana_aois <- tiles %>% pull(aoi1) %>% unique
ghana_degrees <- tiles %>% pull(aoi2) %>% unique

ind <- 8  # index of selected AOI for plotting (from ghana_aois)
xylims <- st_coordinates(ghana)
maprange <-  c(range(xylims[, 1]), range(xylims[, 2]))

p1 <- ggplot() + 
  geom_sf(data = africa, fill = "gray90", color = "grey50", size = 0.2) +
  geom_sf(data = ghana, fill = "grey85", col = "transparent", size = 0.3) +
  geom_sf(data = degrees %>% filter(grid %in% ghana_degrees),
          fill = "transparent", col = "grey70", size = 0.4, lty = 3) +
  geom_sf(data = aois, fill = "transparent", col = "black", size = 0.4) +
  geom_sf(data = aois %>% filter(aois == ind), col = "black", fill = "gray70", 
          size = 0.4) +
  geom_sf_text(data = aois, aes(label = aois)) + 
  coord_sf(xlim = maprange[1:2], ylim = maprange[3:4]) +
  theme_void()

deg_sel <- tiles %>% as_tibble %>% filter(aoi1 %in% 4:12) %>% 
  distinct(aoi1, aoi2) %>% pull()
deg_sel <- c(1349, 1350, 1351, 1414, 1415, 1416, 1478, 1479, 1480)

xylims <- degrees %>% filter(grid %in% deg_sel) %>% st_coordinates(.)
maprange <-  c(range(xylims[, 1]), range(xylims[, 2]))

tile_sel <- tiles %>% filter(aoi1 == ind)  # selected tile
p2 <- ggplot(ghana) + geom_sf(fill = "grey85", col = "grey") +
  geom_sf(data = degrees %>% filter(grid %in% ghana_degrees),
          fill = "transparent", col = "grey70", size = 0.4, lty = 3) +
  geom_sf(data = aois, fill = "transparent", size = 0.3) +
  geom_sf(data = tile_sel, fill = "gray70", size = 0.3) +
  geom_sf(data = tile_sel %>% slice(190), fill = "red3", size = 0.3) +
  coord_sf(xlim = maprange[1:2], ylim = maprange[3:4]) +
  theme_void()
# p2

gpols <- crop(mgridr, tile_sel[190, ]) %>% rasterToPolygons(.) %>%
  st_as_sf %>% st_sf(crs = 4326)
p3 <- ggplot(tile_sel %>% slice(169:171, 189:191, 209:211)) +
  geom_sf(fill = "grey80", size = 0.3) +
  geom_sf(data = gpols, fill = "red3", size = 0.3) +
  theme_void()
# p3

gp <- cowplot::plot_grid(p1, p2, p3, nrow = 1, scale = c(1, 1, 0.7), 
                         labels = LETTERS[1:3], label_x = 0.05)
ggsave(pth("figures/figure2.png"), width = 7, height = 3,
       units = "in", dpi = 300)
```

### Figure 3: Labeller interface
Taken as a screenshot. 

### Figure S1: Bayesian Risk

A plot of the Bayesian risk curves associated with different levels of consensus, for both a cropland and non-cropland consensus label.
```{r, eval=FALSE}
# Heat map function
consensus <- seq(0, 1, 0.05)
risk <- function(r1, r2) {
  r1 * (1 - r2) + (1 - r1) * r2
}

risk_tbl <- tibble(
  Consensus = consensus, `Non-field` = risk(consensus, 0), 
  Field = risk(consensus, 1)
) %>% pivot_longer(cols = contains("field"), names_to = "Label", 
                   values_to = "Risk")
p <- ggplot(risk_tbl) + geom_line(aes(x = Consensus, y = Risk, color = Label)) +   scale_color_manual(values = c("blue", "red")) + 
  theme_linedraw()

ggsave(pth("figures/si_label_risk.png"), width = 5, 
       height = 4, units = "in", dpi = 300, bg = "transparent")
```


### Figure S2: Map reference sample
```{r, eval = FALSE}
ref_sample <- readr::read_csv(
  system.file("extdata", "map_reference_sample.csv", package = "activemapper")
)
ref_sample <- ref_sample %>% st_as_sf(coords = c("x", "y"), crs = 4326)

xylims <- st_coordinates(ghana)
maprange <-  c(range(xylims[, 1]), range(xylims[, 2]))

p <- ggplot(africa) + 
  geom_sf(fill = "gray97", color = "grey", size = 0.25) +
  geom_sf(data = aois, fill = "grey85", col = "black", size = 0.3) +
  geom_sf(data = ref_sample, aes(color = factor(class)), size = 0.1) +
  scale_color_manual(values = c("red", "blue"), 
                     labels = c("Non-cropland", "Cropland"), name = "") + 
  coord_sf(xlim = maprange[1:2], ylim = maprange[3:4]) +
  guides(colour = guide_legend(override.aes = list(size = 1, fill = NA))) + 
  theme_void() + 
  theme(legend.key = element_rect(fill = "grey85", color = "transparent"))

ggsave(pth("figures/si_map_reference_sample.png"), width = 4, 
       height = 4, units = "in", dpi = 300, bg = "transparent")
```


## Results 
### Figure 4: Composite quality
```{r, eval=FALSE}
data("image_quality")

# plot parameters
xylims <- st_coordinates(ghana)
maprange <-  c(range(xylims[, 1]), range(xylims[, 2]))
pal <- colorRampPalette(rev(brewer.pal(9, "RdBu")))
# sc <- scale_colour_gradientn(colours = myPalette(100), limits=c(1, 8))

leglabs <- seq(0.4, 1, 0.1)
p1 <- ggplot(africa) + geom_sf(fill = "gray97", color = "grey", size = 0.25) +
  geom_sf(data = tiles, fill = "grey85", col = "grey", size = 0.3) +
  geom_sf(data = ghana, fill = "transparent", col = "grey", size = 0.3) +
  geom_sf(data = image_quality$tile, 
          mapping = aes(fill = Score, color = Score)) +
  facet_wrap(vars(season), ncol = 2) +
  scale_fill_gradientn(colors = pal(7), 
                       breaks = seq(0.4, 1, 0.1), limits = c(0.4, 1),
                       labels = leglabs) + 
  scale_color_gradientn(colors = pal(7), 
                        breaks = seq(0.4, 1, 0.1), limits = c(0.4, 1), 
                        labels = leglabs) + 
  coord_sf(xlim = maprange[1:2], ylim = maprange[3:4]) + 
  theme_linedraw() + 
  theme(legend.position = "bottom", 
        strip.background = element_rect(fill = "white"), 
        strip.text = element_text(colour = "black"), 
        panel.grid = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank())

p2 <- ggplot(as_tibble(image_quality$tile)) +
  geom_histogram(aes(x = Score), fill = "blue", col = "grey", #bins = 10, 
                 binwidth = 0.05, boundary = 0.1) + 
  scale_x_continuous(breaks = leglabs, labels = leglabs, expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 30)) +
  facet_wrap(vars(season), ncol = 2) + 
  ylab("Count") + 
  theme_linedraw() + 
  theme(strip.background = element_rect(fill = "white"), 
        strip.text = element_text(colour = "black"))

g <- cowplot::plot_grid(p1, p2, nrow = 2, align = "hv", axis = "l",
                        labels = LETTERS[1:2], label_x = 0, 
                        label_y = c(0.97, 1),   
                        scale = c(1, 1), rel_heights = c(1, 0.7))
ggsave(pth("figures/figure4.png"), 
       width = 4, height = 6.5, units = "in", dpi = 300)

```

### Figure 5: Active learning gain
```{r, eval=FALSE}
# iteration metrics
data("iteration_metrics")

# Plots
V1 <- c("Accuracy", "AUC", "F1")

# prepare data
# remove labeller from AOI and select AOIs 1-16
aoinms <- c(paste0("labeller", 1:16), "All")
imetrics <- iteration_metrics %>% 
  filter(Metric %in% V1) %>% 
  filter(AOI %in% aoinms) %>% 
  mutate(AOI = gsub("labeller", "", AOI))

# select out final iteration for each AOI
mx_metrics <- imetrics %>% group_by(AOI) %>% 
  filter(Iteration == max(Iteration)) %>% filter(Metric %in% V1)

# plot
cols <- c(rep("grey", length(unique(imetrics$AOI)) -1), "black")
lsize <- c(rep(0.3, length(unique(imetrics$AOI)) -1), 1)
p <- ggplot(imetrics) + 
  geom_line(aes(Iteration, Score, color = AOI, size = AOI)) +
  geom_point(data = mx_metrics, aes(Iteration, Score, color = AOI), 
             size = 1.2) +
  ggrepel::geom_text_repel(
    data = mx_metrics %>% filter(AOI != "All"), 
    aes(label = AOI, x = Iteration, y = Score), col = "grey50", 
    segment.color = "grey60", point.padding = 0.1, min.segment.length = 0.2,
    segment.size = 0.2, size = 3   
  ) +
  scale_color_manual(values = cols, guide = FALSE) +
  scale_size_manual(values = lsize, guide = FALSE) + 
  scale_x_continuous(expand = c(0.01, 0.01)) + 
  scale_y_continuous(breaks = seq(0.2, 1, 0.1), expand = c(0.01, 0.01), 
                     limits = c(0.2, 1)) + 
  facet_wrap(vars(Metric), ncol = 3) + 
  theme_linedraw() + 
  theme(strip.background = element_rect(fill = "white"), 
        strip.text = element_text(colour = "black"))

ggsave(pth("figures/figure5.png"), 
       width = 7, height = 4, units = "in", dpi = 300)
```

### Figure 6: The impact of training data error
```{r, eval=FALSE}
data("consensus_high_low")

V1 <- c("Accuracy", "AUC", "F1")

# calculate mean across AOIs and join. Convert to factor and reorder for
# plotting
consensus_high_low_mu <- consensus_high_low %>% 
  group_by(Strategy, Metric) %>% 
  summarize(Score = mean(Score)) %>% 
  ungroup() %>% 
  mutate(AOI = "Mean") %>% 
  bind_rows(consensus_high_low, .) %>% 
  filter(Metric %in% V1) %>% 
  mutate(AOI = factor(AOI)) %>% 
  mutate(AOI = forcats::fct_reorder(AOI, ord))

cols <- c("grey50", "grey60", "grey70", "grey80", "black")
sizes <- c(rep(1.5, 4), 2)
shapes <- c(3, 4, 8, 10, 16)
p <- ggplot(consensus_high_low_mu) + 
  geom_point(aes(x = Strategy, y = Score, color = AOI, size = AOI, 
                 shape = AOI)) + 
  ylim(0.4, 1) + xlab("Labelling strategy") + 
  scale_color_manual(values = cols) +
  scale_size_manual(values = sizes) + 
  scale_shape_manual(values = shapes) + 
  facet_wrap(~Metric) + 
  theme_linedraw() + 
  theme(legend.position = "bottom", 
        strip.background = element_rect(fill = "white"), 
        strip.text = element_text(colour = "black"))
ggsave(pth("figures/figure6.png"), height = 4, width = 6, dpi = 300)
```

### Figure 7: Categorical map accuracy


### Figure 8: Cropland maps
```{r, eval=FALSE}
library(stars)
library(ggplot2)
library(aws.s3)
library(RStoolbox)
library(cowplot)

segment_files <- dir(here("external/data/results/segments/merged"),
                     pattern = "boundarymerge", full.names = TRUE)
iid <- as.numeric(gsub("[[:alpha:]]|_|\\.", "", basename(segment_files)))
segment_files <- tibble(file = segment_files, order = iid) %>% arrange(iid)
segment_files <- segment_files %>% filter(!grepl("aoi3_*.*merge.geojson", file))

fdensity <- stars::read_stars(
  system.file("extdata", "field_density005.tif", package = "activemapper")
)

# OS images
osimgs <- get_bucket_df(
  bucket = "activemapper", prefix = "planet/composite_sr_buf_fix/OS/", max = Inf
) %>% as_tibble %>% select(Key)

# example tiles
# aoi 1: tile 486794
# aoi 5: tile 539730
# aoi 11: 
# aoi 15:

flds_1 <- read_sf(segment_files$file[1])
flds_5 <- read_sf(segment_files$file[5])
flds_11 <- read_sf(segment_files$file[11])
flds_15 <- read_sf(segment_files$file[15])

tile_ss <- tiles %>% filter(tile %in% c(486794, 539730, 591243, 616490))
# ggplot(aois %>% filter(aois == 1)) + geom_sf() + 
#   geom_sf(data = tile_ss)
flds_tile1 <- flds_1 %>% filter(st_intersects(., tile_ss[1, ], sparse = FALSE))
flds_tile2 <- flds_5 %>% filter(st_intersects(., tile_ss[2, ], sparse = FALSE))
flds_tile3 <- flds_11 %>% filter(st_intersects(., tile_ss[3, ], sparse = FALSE))
flds_tile4 <- flds_15 %>% filter(st_intersects(., tile_ss[4, ], sparse = FALSE))

impath <- osimgs %>% 
  filter(grepl(paste0(tile_ss$tile, collapse = "|"), Key)) %>% 
  mutate(pth = paste0("/vsis3/activemapper/", Key)) %>% pull(pth)

# img <- read_stars(impath)
# mxval <- st_apply(img, 3, max) %>% pull(max)
# imgngb <- st_rgb(img[, , , 4:2], 3, maxColorValue = mxval[4:2])

fld_tiles <- list(flds_tile1, flds_tile2, flds_tile3, flds_tile4)
isets <- lapply(1:4, function(x) {
  imgr <- brick(impath[x])[[2:4]]
  xylims <- st_bbox(imgr)
  iset <- ggplot() + 
    ggRGB(imgr, maxpixels = 50000, stretch = "lin", ggLayer = TRUE) +
    geom_sf(data = fld_tiles[[x]], fill = "transparent", color = "yellow", 
            size = 0.2) + 
    geom_sf(data = tile_ss[x, ], color = "red", fill = "transparent") + 
    scale_x_continuous(expand = c(0, 0)) + 
    scale_y_continuous(expand = c(0, 0)) + 
    coord_sf(xlim = xylims[c(1, 3)], ylim = xylims[c(2, 4)]) + 
    theme_void()
})
isets[[2]]

# Main map
xylims <- st_coordinates(ghana)
# twk <- diff(range(xylims[, 1])) * 0.05
maprange <-  c(range(xylims[, 1]) + c(-1.25, 1.25), 
               range(xylims[, 2]))

inset_cols <- c("red", "orange", "pink", "brown")
p <- ggplot(africa) + 
  geom_sf(fill = "gray40", color = "grey", size = 0.25) +  
  geom_stars(data = fdensity * 100) +
  geom_sf(data = aois, size = 0.1, fill = "transparent", col = "grey") +
  geom_sf(data = tile_ss, fill = "red", col = "red") +
  scale_fill_viridis_c(name = "% cover", na.value = "transparent") +
  coord_sf(xlim = maprange[1:2], ylim = maprange[3:4]) + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(colour = "white"), 
        legend.title = element_text(colour = "white"))

inset_map <- ggdraw() +
  draw_plot(p) +
  draw_plot(isets[[1]], x = 0.07, y = 0.77, width = 0.2, height = 0.2) + 
  draw_plot(isets[[2]], x = 0.72, y = 0.6, width = 0.2, height = 0.2) + 
  draw_plot(isets[[3]], x = 0.04, y = 0.37, width = 0.2, height = 0.2) + 
  draw_plot(isets[[4]], x = 0.76, y = 0.25, width = 0.2, height = 0.2)

ggsave(filename = here("presentations/figures/cropcover_with_insets.png"), 
       plot = inset_map, bg = "transparent", width = diff(maprange[1:2]), 
       height = diff(maprange[3:4]), units = "in", dpi = 300)


  # geom_stars(data = imgngb) + scale_fill_identity()
  # geom_sf(data = flds_tile)

plot(flds_tile[1])


fboundary <- read_sf(segment_files$file[1])

xylims <- st_coordinates(ghana)
maprange <-  c(range(xylims[, 1]), range(xylims[, 2]))

pal <- RColorBrewer::brewer.pal(n = 9, "Spectral")[c(1, 2, 3, 4, 9)]

# Panels, organized top to bottom
# Panel 1: Cropland probabilities, with 3 m probability side maps (tiles)
p <- ggplot(africa) + 
  geom_sf(fill = "gray97", color = "grey", size = 0.25) +  
  geom_stars(data = fdensity * 100) + 
  geom_sf(data = aois, size = 0.1, fill = "transparent", col = "grey") + 
  scale_fill_viridis_c(name = "% cover", na.value = "transparent") + 
  coord_sf(xlim = maprange[1:2], ylim = maprange[3:4]) + 
  theme_void()

# Panel 2: Cropland cover, with polygon side maps over composites (tiles)
p <- ggplot(africa) + 
  geom_sf(fill = "gray97", color = "grey", size = 0.25) +  
  geom_stars(data = fdensity * 100) + 
  geom_sf(data = aois, size = 0.1, fill = "transparent", col = "grey") + 
  geom_sf(data = tile_ss, fill = "red", col = "red") + 
  scale_fill_viridis_c(name = "% cover", na.value = "transparent") + 
  coord_sf(xlim = maprange[1:2], ylim = maprange[3:4]) + 
  theme_void()
p

# Panel 3: Average field size (kriging adjusted?), 

# Panel 4: Field number (kriging adjusted)




```




### Figure S3: Initial training site distribution
Figure showing distribution of initial 500 samples per cluster, as well as distribution of points per iteration.  
```{r trainingsites, eval=FALSE}
data("train_val_sites")

qsites <- instance_tbls$kml_data %>% 
  filter(aoi %in% paste0("labeller", 1:16)) %>% 
  filter(kml_type == "Q") %>% select(name, x, y) %>% distinct() %>%
  mutate(Cluster = "Training reference") %>% 
  st_as_sf(coords = c("x", "y"), crs = 4326) %>% select(Cluster, name)

train_val_q <- rbind(train_val_sites$initial %>% select(-iteration), qsites)
      

# initial train cluster panel
xylims <- st_coordinates(ghana)
maprange <-  c(range(xylims[, 1]), range(xylims[, 2]))
pal <- RColorBrewer::brewer.pal(n = 9, "Spectral")[c(1, 2, 3, 4, 9)]

p1 <- ggplot(africa) + 
  geom_sf(fill = "gray97", color = "grey", size = 0.25) +
  geom_sf(data = aois, fill = "grey85", col = "black", size = 0.3) +
  geom_sf(data = train_val_q, aes(color = Cluster, fill = Cluster), 
          size = 0.05) +   
  scale_color_manual(values = pal) +
  coord_sf(xlim = maprange[1:2], ylim = maprange[3:4]) +
  guides(colour = guide_legend(override.aes = list(size = 1, fill = NA))) + 
  theme_void() + 
  theme(legend.key = element_rect(fill = "grey85", color = "transparent"))

pal <- c(RColorBrewer::brewer.pal(n = 4, "Spectral"), "white")
p2 <- ggplot(africa) + geom_sf(fill = "gray97", color = "grey", size = 0.25) +
  geom_sf(data = aois, fill = "grey85", col = "black", size = 0.3) + 
  geom_sf(data = train_val_sites$active, aes(color = Type), size = 0.05) +
  scale_color_manual(values = pal) +
  coord_sf(xlim = maprange[1:2], ylim = maprange[3:4]) +
  guides(colour = guide_legend(override.aes = list(size = 1, fill = NA))) + 
  theme_void() + 
  theme(legend.key = element_rect(fill = "grey85", color = "transparent"))

# arrange and save
# cp_theme1 <- theme(legend.box.just = "left")
cp_theme1 <- theme(legend.margin = margin(0, 0, 0, 0, "cm"), 
                   legend.text.align = 0, legend.title.align = 0)
gp <- cowplot::plot_grid(p1 + cp_theme1, 
                         p2 + cp_theme1, 
                         nrow = 2,
                         align = "hv", #axis = "l",
                         labels = LETTERS[1:2], label_x = 0.05)
ggsave(pth("figures/si_training_validation_pts.png"), width = 4, 
       height = 6, units = "in", dpi = 300, bg = "transparent")

```

### Figure S4: Label count and quality
```{r labelquality, eval=FALSE}
data("label_summary")

# combine with label_quality
label_quality2 <- left_join(
  label_summary$scores, label_summary$score_stats, by = "uuid"
) %>% select(uuid, score, N, Mean, StDev) %>% 
  mutate(uuid = substr(uuid, 1, 5)) %>% rename(ID = uuid)

# find Q counts to get IDs infrequent workers
toofewq <- label_quality2 %>% group_by(ID) %>% count() %>% filter(n < 10)
label_quality2 <- label_quality2 %>% filter(!ID %in% toofewq$ID)

# Q site accuracy
p1 <- ggplot(label_quality2) + 
  geom_boxplot(aes(x = reorder(ID, -score), y = score, fill = ID), 
               col = "grey50", varwidth = TRUE, show.legend = FALSE,
               outlier.size = 1) + 
  geom_point(aes(x = ID, y = Mean), shape = 4, size = 2) +
  scale_y_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1), 
                     expand = c(0, 0.01)) + 
  scale_fill_manual(values = rep("grey", length(unique(label_quality2$ID)))) + 
  xlab("ID") + ylab("Score") + 
  theme_linedraw() + 
  theme(axis.text = element_text(size = 11), 
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

# N sites by type
yl <- c(0, ceiling(max(label_summary$nlabels$n) * 1.01))
p2 <- label_summary$nlabels %>% filter(!ID %in% toofewq$ID) %>% 
  group_by(ID, kml_type) %>% 
  ggplot() + 
  geom_bar(aes(x = reorder(ID, -n), y = n, fill = kml_type), 
           position = "dodge", stat = "identity") +
  xlab("ID") + ylab("N") + 
  labs(fill = "Map Type") + 
  scale_fill_manual(values = c("grey40", "grey70")) + 
  scale_y_continuous(breaks = seq(yl[1], yl[2], by = 200), 
                     expand = c(0, 0.01), limits = yl) + 
  theme_linedraw() + 
  theme(legend.position = c(0.7, 0.85), axis.text = element_text(size = 11), 
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

cp_theme <- theme(axis.text = element_text(size = 11),  
                  legend.text = element_text(size = 11),
                  legend.title = element_text(size = 11),
                  axis.title = element_text(size = 12))
gp <- cowplot::plot_grid(p2 + cp_theme, p1 + cp_theme, nrow = 2, 
                         labels = LETTERS[1:2], label_x = 0.0) 
                         #rel_widths = c(0.65, 0.45))
ggsave(pth("figures/si_training_qual_n.png"), width = 4, 
       height = 8, units = "in", dpi = 300, bg = "transparent")
```

### Figures S5 and S6: Consensus label (Bayesian) risk

Plots of mean risk in space, divided into training and validation sites

```{r riskpoints, eval=FALSE}
data("label_risk")

# Training/validation points
label_risk_pts <- label_risk$pts %>% 
  st_as_sf(coords = c("x", "y"), crs = 4326)
# label_consensus %>% distinct(aoi)
# label_risk %>% filter(is.na(meanrisk))

# # prepare for histograms
# clusters <- paste0("labeller", c("", "trainsouth", "trainsouthnl", "trainsw"))
# new_cluster_nms <- paste0("Cl", c("1", "2a", "2b", "3"))
# 
# label_risk_tb <- as_tibble(label_risk_pts) %>% 
#   mutate(aoi = case_when(
#     aoi == clusters[1] ~ "-3",
#     aoi == clusters[2] ~ "-2",
#     aoi == clusters[3] ~ "-1",
#     aoi == clusters[4] ~ "0", 
#     TRUE ~ gsub("labeller", "", aoi) 
#   )) %>% 
#   mutate(ord = as.numeric(aoi)) %>% arrange(aoi) %>% 
#   mutate(aoi = case_when(
#     aoi == "-3" ~ new_cluster_nms[1], 
#     aoi == "-2" ~ new_cluster_nms[2],
#     aoi == "-1" ~ new_cluster_nms[3],
#     aoi %in% "0" ~ new_cluster_nms[4], 
#     TRUE ~ aoi 
#   )) %>% 
#   mutate(aoi = forcats::fct_reorder(aoi, ord))
# 
# # summarize
# label_risk_stats <- label_risk_tb %>% group_by(aoi, usage) %>% 
#   summarize(Risk = mean(Risk, na.rm = TRUE)) %>% 
#   ungroup()


xylims <- st_coordinates(ghana)
maprange <-  c(range(xylims[, 1]), range(xylims[, 2]))
pal <- colorRampPalette(rev(RColorBrewer::brewer.pal(9, "RdBu")))
zlim <- c(0, round(max(label_risk_pts$Risk, na.rm = TRUE), 1))

p <- ggplot(africa) + 
  geom_sf(fill = "gray97", color = "grey", size = 0.25) +
  geom_sf(data = aois, fill = "grey85", col = "black", size = 0.3) +
  geom_sf(data = label_risk_pts, aes(color = Risk, fill = Risk), 
          size = 0.1) +
  facet_wrap(~usage) + 
  scale_color_gradientn(colours = pal(20), limits = zlim) + 
  scale_fill_gradientn(colours = pal(20), limits = zlim) +
  coord_sf(xlim = maprange[1:2], ylim = maprange[3:4]) +
  guides(fill = guide_colorbar(nbin = 20), color = FALSE) +
  theme_void() + 
  theme(legend.key = element_rect(fill = "grey85", color = "transparent"))
ggsave(pth("figures/si_label_risk_map.png"), width = 7, 
       height = 5, units = "in", dpi = 300, bg = "transparent")
```

Risk histograms. 
```{r riskhists, eval=FALSE}
p <- ggplot(label_risk$pts) + 
  geom_histogram(aes(x = Risk), fill = "grey50", bins = 20) + 
  geom_vline(data = label_risk$stats, aes(xintercept = Risk), size = 0.5, 
             linetype = 1) + 
  scale_y_continuous(expand = c(0, 0), breaks = seq(0, 150, 25), 
                     labels = c("", 25, "", 75, "", 125, ""), 
                     limits = c(0, 150)) + 
  ylab("Number of sites") + 
  facet_grid(aoi ~ usage) +
  theme_linedraw() + 
  theme(strip.background = element_rect(fill = "white"), 
        strip.text = element_text(size = 9, colour = "black"),  
        axis.text.x = element_text(size = 9, hjust = 1, vjust = 0.5, 
                                   angle = 90), 
        axis.text.y = element_text(size = 7))
ggsave(pth("figures/si_label_risk_hists.png"), width = 3, 
       height = 9, units = "in", dpi = 300, bg = "transparent")
```

```{r, eval=FALSE}
data("label_risk_metrics")

label_risk_metrics %>% 
  filter(Metric != "TSS") %>%  
  ggplot() + geom_point(aes(Risk, Score)) + 
  geom_smooth(aes(Risk, Score), method = "gam") + 
  facet_wrap(~Metric)

label_risk_metrics %>% select(aoi, Metric, Score) %>% 
  tidyr::pivot_wider(names_from = "Metric", values_from = "Score") %>% 
  ggplot() + geom_point(aes(Precision, Accuracy))

label_risk_metrics %>% select(aoi, Metric, Score) %>% 
  tidyr::pivot_wider(names_from = "Metric", values_from = "Score") %>% 
  ggplot() + geom_point(aes(Precision, F1))

label_risk_metrics %>% select(aoi, Metric, Score) %>% 
  tidyr::pivot_wider(names_from = "Metric", values_from = "Score") %>% 
  ggplot() + geom_point(aes(Recall, F1))

label_risk_metrics %>% select(aoi, Metric, Score) %>% 
  tidyr::pivot_wider(names_from = "Metric", values_from = "Score") %>% 
  ggplot() + geom_point(aes(Precision, Recall))

label_risk_metrics %>% select(aoi, Metric, Score) %>% 
  tidyr::pivot_wider(names_from = "Metric", values_from = "Score") %>% 
  ggplot() + geom_point(aes(Precision, FPR))
label_risk_metrics %>% select(aoi, Metric, Score) %>% 
  tidyr::pivot_wider(names_from = "Metric", values_from = "Score") %>% 
  ggplot() + geom_point(aes(Recall, FPR))


```




### Figure S7: Random versus active sampling
```{r, eval=FALSE}
data("iteration_metrics")

# Plots
V1 <- c("Accuracy", "AUC", "F1")

# prepare data
# remove labeller from AOI and select AOIs 1-16
aois <- c(paste0("labeller", c(1, 8, 15, "1r", "8r", "15r")))
imetrics <- iteration_metrics %>% 
  filter(Metric %in% V1 & AOI %in% aois) %>% 
  mutate(AOI = gsub("labeller", "", AOI)) %>% 
  mutate(type = case_when(
    AOI %in% c(1, 8, 15) ~ "active", 
    AOI %in% c("1r", "8r", "15r") ~ "random"
  )) %>% 
  mutate(AOI = gsub("r", "", AOI)) %>% 
  tidyr::pivot_wider(names_from = "type", values_from = "Score") %>% 
  mutate(delta = (active - random) / random * 100) 

imetrics_all <- imetrics %>% filter(Iteration < 4) %>% 
  group_by(Iteration, Metric) %>% 
  summarize(active = mean(active), random = mean(random), 
            delta = mean(delta)) %>%
  ungroup() %>% mutate(AOI = "All") %>% 
  select(AOI, Iteration, Metric, active, random, delta)
imetrics <- bind_rows(imetrics, imetrics_all)

# select out final iteration for each AOI
mx_metrics <- imetrics %>% group_by(AOI) %>% 
  filter(Iteration == max(Iteration)) %>% filter(Metric %in% V1)

# plot
cols <- c(rep("grey50", length(unique(imetrics$AOI)) -1), "black")
lsize <- c(rep(0.3, length(unique(imetrics$AOI)) -1), 1)
p <- ggplot(imetrics) + 
  geom_hline(yintercept = 0, linetype = "dotted", col = "grey40") +
  geom_line(aes(Iteration, delta, color = AOI, size = AOI)) +
  geom_point(data = mx_metrics, aes(Iteration, delta, color = AOI), 
             size = 1.2) +
  ggrepel::geom_text_repel(
    data = mx_metrics %>% filter(AOI != "All"), 
    aes(label = AOI, x = Iteration, y = delta), col = "grey50", 
    segment.color = "grey60", point.padding = 0.2, min.segment.length = 0.2,
    segment.size = 0.2, size = 3, nudge_x = 0 
  ) +
  scale_color_manual(values = cols, guide = FALSE) +
  scale_size_manual(values = lsize, guide = FALSE) + 
  scale_x_continuous(expand = c(0.01, 0.01)) + 
  scale_y_continuous(expand = c(0.01, 0.01), breaks = seq(-8, 4, 1)) + 
  ylab("% difference") +                    
  facet_wrap(vars(Metric), ncol = 3) +
  theme_linedraw() + 
  theme(panel.grid.minor.x = element_blank(), 
        strip.background = element_rect(fill = "white"), 
        strip.text = element_text(colour = "black"))

ggsave(pth("figures/si_random_vs_active.png"), 
       width = 6, height = 4, units = "in", dpi = 300)

```

### Figure S8: Training data error impact on probability images
```{r, eval = FALSE}
probpal <- viridis::viridis
cprob <- raster(here::here("external/prob/image_c294_r532.tif"))
hprob <- raster(here::here("external/prob/image_c294_r532_high.tif"))
lprob <- raster(here::here("external/prob/image_c294_r532_low.tif"))

png(pth("figures/si_label_strategy_probs.png"), height = 2.5,
    width = 8, res = 300, units = "in", bg = "transparent")
par(mfrow = c(1, 3), mar = c(0, 0.5, 0, 1.75), oma = c(0, 0, 0, 2))
plot(as(extent(cprob), "SpatialPolygons"), lty = 0)
plot(cprob, lty = 0, add = TRUE, legend = FALSE, zlim = c(0, 100),
     col = probpal(20))
mtext("A", side = 3, line = -2.5, adj = -0.02, cex = 1)
plot(as(extent(cprob), "SpatialPolygons"), lty = 0, cex.main = 2)
plot(hprob, lty = 0, add = TRUE, legend = FALSE, zlim = c(0, 100),
     col = probpal(20))
mtext("B", side = 3, line = -2.5, adj = -0.02, cex = 1)
plot(as(extent(cprob), "SpatialPolygons"), lty = 0)
plot(lprob, lty = 0, add = TRUE, zlim = c(0, 100),
     legend.width = 1, legend.shrink = 0.5, col = probpal(20))
mtext("C", side = 3, line = -2.5, adj = -0.02, cex = 1)
dev.off()

```


### Figure S9: Segmentation statistics (grid scale)

[Check whether the means need to be weighted or not]
[Check whether need to redo median]
```{r segstats, eval=FALSE}
# data("top_label_data")
# data("field_validation_stats")
data("segment_quality_stats")
# data
datnms <- c("top_label_data", "field_validation_stats")#,
            # "tile_aoi_validation_stats")
for(i in datnms) {
  load(system.file(glue::glue("extdata/{i}.rda"), package = "activemapper"))
}

# extract distributions
human <- top_label_data$stats %>%
  mutate(mu_prop = NA, type = "Validation") %>%
  select(-contains("id"))
machine <- field_validation_stats %>%
  mutate(type = "Segmentation")
humachine <- bind_rows(human, machine) %>%
  mutate(aoi = as.numeric(gsub("labeller", "", aoi))) %>%
  arrange(aoi)

squal <- segment_quality_stats %>% 
  filter(scale == "grid" & aoi != "All") %>% 
  mutate(aoi = as.numeric(aoi))
# 
# # Summarize AOI-wise averages (field size)
# humachine_sum <- humachine %>% group_by(aoi, type) %>% 
#   summarize(Median = median(Mean), Mean = mean(Mean)) %>% 
#   ungroup() %>% 
#   tidyr::pivot_longer(cols = Median:Mean, names_to = "Stat")
# # field number
# humachine_sum_n <- humachine %>% group_by(aoi, type) %>% 
#   summarize(Median = median(n), Mean = mean(n)) %>% 
#   ungroup() %>% 
#   tidyr::pivot_longer(cols = Median:Mean, names_to = "Stat")

# plots
fcols <- c(Segmentation = rgb(0, 0, 1, alpha = 0.5),
          Validation = rgb(1, 0, 0, alpha = 0.5))
brks <- seq(0, 30, 5)
theme_fun <- function(x) {
  theme_linedraw() + 
  theme(legend.position = "bottom", legend.text = element_text(size = 11),
        strip.background = element_rect(fill = "white"), 
        strip.text = element_text(size = 11, colour = "black"),  
        axis.text.x = element_text(size = 11, hjust = 1, vjust = 0.5, 
                                   angle = 90), 
        axis.text.y = element_text(size = 11))
}

# Field size
p <- ggplot(humachine) + 
  geom_density(aes(x = Mean, y = ..count.., fill = type), col = "transparent", 
               linetype = "blank") +  
  geom_vline(data = squal %>% filter(measure == "area"), 
             aes(xintercept = value, color = type, linetype = Stat), 
             size = 0.5) +
  scale_x_continuous(expand = c(0.03, 0.03), breaks = brks, limits = c(0, 30)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_color_manual(name = "", values = c("blue", "red"), guide = FALSE) + 
  scale_fill_manual(name = "", values = fcols) +  
  # scale_linetype_manual(name = "", values = c("dashed", "solid")) +  
  scale_linetype("") +  
  facet_wrap(vars(aoi)) + 
  xlab("Field size (ha)") + ylab("Count") + 
  theme_fun()
ggsave(pth("figures/si_validation_stats_fha2.png"), 
       width = 7, height = 7, units = "in", dpi = 300)

# field number
brks <- seq(0, 20, 5)
p2 <- ggplot(humachine) + 
  geom_density(aes(x = n, y = ..count.., fill = type), col = "transparent", 
               linetype = "blank") +  
  geom_vline(data = squal %>% filter(measure == "n"), 
             aes(xintercept = value, color = type, linetype = Stat), 
             size = 0.5) +
  scale_x_continuous(expand = c(0.03, 0.03), breaks = brks, limits = c(0, 20)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 40)) +
  scale_color_manual(name = "", values = c("blue", "red"), guide = FALSE) + 
  scale_fill_manual(name = "", values = fcols) +  
  # scale_linetype_manual(name = "", values = c("dashed", "solid")) +  
  scale_linetype("") +  
  facet_wrap(vars(aoi)) + 
  xlab("Number of fields") + ylab("Count") + 
  theme_fun()
ggsave(pth("figures/si_validation_stats_fn2.png"), 
       width = 7, height = 7, units = "in", dpi = 300)

```

<!-- ### Figure S10: Segmentation statistics, tile scale -->
<!-- ```{r, eval=FALSE} -->
<!-- data("tile_aoi_validation_stats") -->

<!-- humachine <- tile_aoi_validation_stats$tile %>%  -->
<!--   mutate(type = ifelse(grepl("segments", type), "Segmentation", type), -->
<!--          type = ifelse(grepl("validation", type), "Validation", type)) %>%  -->
<!--   select(type, aoi, tile, area_mu, area_med, n_mu) %>%  -->
<!--   rename(Mean = area_mu, Median = area_med) -->

<!-- humachine_sum <- humachine %>% group_by(aoi, type) %>%  -->
<!--   summarize(Median = median(Mean), Mean = mean(Mean)) %>%  -->
<!--   ungroup() %>%  -->
<!--   tidyr::pivot_longer(cols = Median:Mean, names_to = "Stat") -->

<!-- humachine_sum_n <- humachine %>% group_by(aoi, type) %>%  -->
<!--   summarize(Median = median(n_mu), Mean = mean(n_mu)) %>%  -->
<!--   ungroup() %>%  -->
<!--   tidyr::pivot_longer(cols = Median:Mean, names_to = "Stat") -->

<!-- # Field size -->
<!-- brks <- seq(0, 20, 5) -->
<!-- p <- ggplot(humachine) +  -->
<!--   geom_density(aes(x = Mean, y = ..count.., fill = type), col = "transparent",  -->
<!--                linetype = "blank") +   -->
<!--   geom_vline(data = humachine_sum,  -->
<!--              aes(xintercept = value, color = type, linetype = Stat),  -->
<!--              size = 0.5) + -->
<!--   scale_x_continuous(expand = c(0.03, 0.03), breaks = brks, limits = c(0, 20)) + -->
<!--   scale_y_continuous(expand = c(0, 0)) + -->
<!--   scale_color_manual(name = "", values = c("blue", "red"), guide = FALSE) +  -->
<!--   scale_fill_manual(name = "", values = fcols) +   -->
<!--   # scale_linetype_manual(name = "", values = c("dashed", "solid")) +   -->
<!--   scale_linetype("") +   -->
<!--   facet_wrap(vars(aoi)) +  -->
<!--   xlab("Field size (ha)") + ylab("Count") +  -->
<!--   theme_fun() -->
<!-- ggsave(pth("figures/si_tile_validation_stats_fha.png"),  -->
<!--        width = 7, height = 7, units = "in", dpi = 300) -->

<!-- # field number -->
<!-- brks <- seq(0, 20, 5) -->
<!-- p2 <- ggplot(humachine) +  -->
<!--   geom_density(aes(x = n_mu, y = ..count.., fill = type), col = "transparent",  -->
<!--                linetype = "blank") +   -->
<!--   geom_vline(data = humachine_sum_n,  -->
<!--              aes(xintercept = value, color = type, linetype = Stat),  -->
<!--              size = 0.5) + -->
<!--   scale_x_continuous(expand = c(0.03, 0.03), breaks = brks, limits = c(0, 20)) + -->
<!--   scale_y_continuous(expand = c(0, 0)) + #, limits = c(0, 40)) + -->
<!--   scale_color_manual(name = "", values = c("blue", "red"), guide = FALSE) +  -->
<!--   scale_fill_manual(name = "", values = fcols) +   -->
<!--   # scale_linetype_manual(name = "", values = c("dashed", "solid")) +   -->
<!--   scale_linetype("") +   -->
<!--   facet_wrap(vars(aoi)) +  -->
<!--   xlab("Number of fields") + ylab("Count") +  -->
<!--   theme_fun() -->
<!-- ggsave(pth("figures/si_tile_validation_stats_fn.png"),  -->
<!--        width = 7, height = 7, units = "in", dpi = 300) -->
<!-- ``` -->

<!-- ### Figure S11: Segmentation statistics: grid, tile, and AOI scales -->

<!-- Read back in segments to get distributions -->
<!-- ```{r, eval = FALSE} -->
<!-- data("tile_aoi_validation_stats") -->

<!-- # # Read in segments, drop old AOI3 -->
<!-- # segment_files <- dir(here("external/data/results/segments/merged"), -->
<!-- #                      pattern = "boundarymerge", full.names = TRUE) -->
<!-- # iid <- as.numeric(gsub("[[:alpha:]]|_|\\.", "", basename(segment_files))) -->
<!-- # segment_files <- tibble(file = segment_files, order = iid) %>% arrange(iid) -->
<!-- # segment_files <- segment_files %>% filter(!grepl("aoi3_*.*merge.geojson", file)) -->
<!-- #  -->
<!-- # # area and quiet func -->
<!-- # ha <- function(x) as.numeric(units::set_units(st_area(x), "ha")) -->
<!-- # quiet <- function(x) suppressWarnings(suppressMessages(x)) -->

<!-- humachine_sum <- tile_aoi_validation_stats$aoi %>%  -->
<!--   select(type, aoi, area_mu, area_med) %>%  -->
<!--   rename(Mean = area_mu, Median = area_med) %>%  -->
<!--   tidyr::pivot_longer(cols = Median:Mean, names_to = "Stat") %>%  -->
<!--   tidyr::pivot_wider(names_from = type, values_from = value) -->

<!-- aoi_wide <- tile_aoi_validation_stats$aoi %>% group_by(type) %>%  -->
<!--   summarize(Mean = weighted.mean(area_mu, w = n),  -->
<!--             Median = weighted.mean(area_med, w = n)) %>%  -->
<!--   tidyr::pivot_longer(cols = Median:Mean, names_to = "Stat") %>%  -->
<!--   tidyr::pivot_wider(names_from = type, values_from = value) %>%  -->
<!--   mutate(aoi = "All") %>% select(aoi, !!names(.)) -->

<!-- p <- ggplot(humachine_sum) + -->
<!--   geom_point(aes(x = segments, y = validation)) +  -->
<!--   geom_point(data = aoi_wide, aes(x = segments, y = validation), color = "red") +  -->
<!--   scale_x_continuous(limits = c(0, 8)) +  -->
<!--   scale_y_continuous(limits = c(0, 8)) +  -->
<!--   ggrepel::geom_text_repel( -->
<!--     aes(label = aoi, x = segments, y = validation), col = "grey50",  -->
<!--     segment.color = "grey60", point.padding = 0.1, min.segment.length = 0.2, -->
<!--     segment.size = 0.2, size = 3    -->
<!--   ) +  -->
<!--   xlab("Segmentation field size (ha)") + ylab("Validation field size (ha)") +  -->
<!--   geom_abline(slope = 1) + facet_wrap(vars(Stat)) +  -->
<!--   theme_linedraw() +  -->
<!--   theme(strip.background = element_rect(fill = "white"),  -->
<!--         strip.text = element_text(colour = "black")) -->

<!-- ``` -->

